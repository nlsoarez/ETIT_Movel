<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Outages</title>
    <style>
        .ganho {
            color: green;
        }

        .perda {
            color: red;
        }

        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 5px;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>

    <h1>Consulta de Outages</h1>

    <div>
        <label for="matricula">Matrícula:</label>
        <input type="text" id="matricula" />
        <button onclick="consultarOutages()">Consultar</button>
    </div>

    <div id="resumo"></div>
    <div id="tempoMedio"></div>

    <table id="tabelaResultados">
        <thead>
            <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Tempo (minutos)</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        // Dados simulados da planilha
        const dadosPlanilha = [
            ['001', 'f160641', '01/03/2025 22:30', '01/03/2025 23:30', 1, 1, 1, 1],
            ['002', 'f160641', '02/03/2025 00:30', '02/03/2025 02:30', 1, 0, 1, 1],
            ['003', 'f160641', '03/03/2025 03:15', '03/03/2025 05:00', 1, 0, 0, 1],
            // Mais linhas podem ser adicionadas aqui
        ];

        // Função para parsear a data e hora
        function parseDate(dateStr) {
            console.log("Data recebida para processamento:", dateStr); // Verificando o valor
            if (typeof dateStr !== "string") {
                console.log("Valor de dateStr inválido:", dateStr);
                return null; // Caso inválido, retornamos null para evitar erro
            }

            const [date, time] = dateStr.split(' ');
            const [day, month, year] = date.split('/');
            const [hours, minutes] = time.split(':');
            
            console.log(`Processando data: ${dateStr}`);
            
            return new Date(year, month - 1, day, hours, minutes);
        }

        // Função para consultar outages
        function consultarOutages() {
            const matricula = document.getElementById('matricula').value.trim().toLowerCase();
            if (!matricula) {
                alert("Digite uma matrícula!");
                return;
            }

            let ganhos = [];
            let perdas = [];
            let tempos = [];

            console.log("Matrícula informada:", matricula);

            dadosPlanilha.forEach(row => {
                console.log("Linha processada:", row);

                // Ignorar caso não tenha dados suficientes na linha
                if (!row[2] || !row[3]) {
                    console.log("Data ou hora ausente na linha:", row);
                    return; // Ignora essa linha e continua o loop
                }

                // Comparar matrícula
                if (row[1] && row[1].toString().toLowerCase() === matricula) {
                    let ganhoHFC = (row[4] === 1 && row[5] === 1);
                    let perdaHFC = (row[4] === 1 && row[5] === 0);
                    let ganhoGPON = (row[6] === 1 && row[7] === 1);
                    let perdaGPON = (row[6] === 1 && row[7] === 0);

                    // Processar datas
                    let inicio = parseDate(row[2]);
                    let fim = parseDate(row[3]);
                    
                    if (inicio && fim) {
                        let tempo = (fim - inicio) / 60000; // Tempo em minutos
                        tempos.push(tempo);
                    }

                    if (ganhoHFC || ganhoGPON) ganhos.push({ id: row[0], tempo: tempos.at(-1) || '-' });
                    if (perdaHFC || perdaGPON) perdas.push({ id: row[0], tempo: tempos.at(-1) || '-' });
                }
            });

            if (ganhos.length === 0 && perdas.length === 0) {
                alert("Nenhuma ocorrência encontrada para a matrícula informada.");
            }

            let tempoMedio = tempos.length ? (tempos.reduce((a, b) => a + b, 0) / tempos.length).toFixed(2) : "-";
            document.getElementById('resumo').innerText = `Ganhos: ${ganhos.length} | Perdas: ${perdas.length}`;
            document.getElementById('tempoMedio').innerText = `Tempo médio: ${tempoMedio} minutos`;

            const tabela = document.getElementById('tabelaResultados').getElementsByTagName('tbody')[0];
            tabela.innerHTML = "";

            ganhos.forEach(entry => {
                let row = tabela.insertRow();
                row.insertCell(0).innerText = entry.id;
                row.insertCell(1).innerHTML = '<span class="ganho">Ganho</span>';
                row.insertCell(2).innerText = entry.tempo;
            });

            perdas.forEach(entry => {
                let row = tabela.insertRow();
                row.insertCell(0).innerText = entry.id;
                row.insertCell(1).innerHTML = '<span class="perda">Perda</span>';
                row.insertCell(2).innerText = entry.tempo;
            });
        }
    </script>

</body>
</html>
