<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload de Planilha e Cálculos de Outages</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        #result, #consultation-result {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: center;
        }
    </style>
</head>
<body>

<h1>Upload de Planilha e Análise de Outages</h1>

<!-- Formulário para upload da planilha -->
<input type="file" id="fileInput" accept=".xlsx">
<button onclick="processFile()">Processar Planilha</button>

<!-- Resultados do cálculo -->
<div id="result" style="display:none;">
    <h2>Resultados</h2>
    <p><strong>Tempo médio por login:</strong></p>
    <table id="avgTimeTable"></table>

    <p><strong>Outages Ganhos e Perdidos:</strong></p>
    <table id="outagesTable"></table>

    <p><strong>Horários com Mais Perdas:</strong></p>
    <table id="lossTimesTable"></table>
</div>

<!-- Consulta de outages por login -->
<h2>Consulta de Outages por Login</h2>
<input type="text" id="loginQuery" placeholder="Digite o Login">
<button onclick="consultLogin()">Consultar</button>

<div id="consultation-result" style="display:none;">
    <h3>Outages de Login</h3>
    <table id="consultationTable"></table>
</div>

<script>
    let data = [];

    function processFile() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return alert('Por favor, faça o upload de um arquivo.');

        const reader = new FileReader();
        reader.onload = function(event) {
            const data = event.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]]; // Assume-se que a planilha está na primeira aba
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            let parsedData = [];

            // Processa as linhas a partir da segunda (ignorando cabeçalho)
            for (let i = 1; i < rows.length; i++) {
                const columns = rows[i];
                if (columns.length < 8) continue;

                const outage = columns[0];
                const login = columns[1];
                const inicio = new Date(columns[2]);
                const fim = new Date(columns[3]);
                const hfcVolume = parseInt(columns[4]);
                const hfcIndicador = parseInt(columns[5]);
                const gponVolume = parseInt(columns[6]);
                const gponIndicador = parseInt(columns[7]);

                const tempo = (fim - inicio) / 1000 / 60; // Tempo em minutos

                if ((hfcVolume === 0 || gponVolume === 0)) continue; // Desconsiderar volumes com 0

                const statusHfc = (hfcVolume === 1 && hfcIndicador === 1) ? 'Ganho' : 'Perda';
                const statusGpon = (gponVolume === 1 && gponIndicador === 1) ? 'Ganho' : 'Perda';
                const status = (statusHfc === 'Ganho' && statusGpon === 'Ganho') ? 'Ganho' : 'Perda';

                parsedData.push({ outage, login, tempo, status });
            }

            data = parsedData;
            calculateResults();
        };
        reader.readAsBinaryString(file);
    }

    function calculateResults() {
        // Calculando o tempo médio por login
        const loginTimes = {};
        const loginOutages = {};
        const timeLoss = {};

        data.forEach(item => {
            if (!loginTimes[item.login]) {
                loginTimes[item.login] = { totalTime: 0, count: 0, losses: 0, gains: 0, outages: [] };
            }

            loginTimes[item.login].totalTime += item.tempo;
            loginTimes[item.login].count++;
            loginTimes[item.login].outages.push(item.outage);
            if (item.status === 'Perda') {
                loginTimes[item.login].losses++;
            } else {
                loginTimes[item.login].gains++;
            }

            const hour = new Date(item.tempo).getHours();
            if (!timeLoss[hour]) {
                timeLoss[hour] = 0;
            }
            if (item.status === 'Perda') {
                timeLoss[hour]++;
            }
        });

        // Exibindo tempo médio por login
        const avgTimeTable = document.getElementById('avgTimeTable');
        avgTimeTable.innerHTML = `
            <tr>
                <th>Login</th>
                <th>Tempo Médio (min)</th>
            </tr>`;
        for (const login in loginTimes) {
            const avgTime = (loginTimes[login].totalTime / loginTimes[login].count).toFixed(2);
            avgTimeTable.innerHTML += `
                <tr>
                    <td>${login}</td>
                    <td>${avgTime}</td>
                </tr>`;
        }

        // Exibindo outages ganhos e perdidos
        const outagesTable = document.getElementById('outagesTable');
        outagesTable.innerHTML = `
            <tr>
                <th>Login</th>
                <th>Outages Ganhos</th>
                <th>Outages Perdidos</th>
            </tr>`;
        for (const login in loginTimes) {
            outagesTable.innerHTML += `
                <tr>
                    <td>${login}</td>
                    <td>${loginTimes[login].gains}</td>
                    <td>${loginTimes[login].losses}</td>
                </tr>`;
        }

        // Exibindo horários com mais perdas
        const lossTimesTable = document.getElementById('lossTimesTable');
        lossTimesTable.innerHTML = `
            <tr>
                <th>Hora</th>
                <th>Quantidade de Perdas</th>
            </tr>`;
        for (const hour in timeLoss) {
            lossTimesTable.innerHTML += `
                <tr>
                    <td>${hour}:00</td>
                    <td>${timeLoss[hour]}</td>
                </tr>`;
        }

        document.getElementById('result').style.display = 'block';
    }

    function consultLogin() {
        const loginQuery = document.getElementById('loginQuery').value.trim();
        if (!loginQuery) return alert('Digite um login para consulta.');

        const filteredOutages = data.filter(item => item.login === loginQuery);
        const consultationTable = document.getElementById('consultationTable');
        consultationTable.innerHTML = `
            <tr>
                <th>Outage</th>
                <th>Status</th>
            </tr>`;
        filteredOutages.forEach(item => {
            consultationTable.innerHTML += `
                <tr>
                    <td>${item.outage}</td>
                    <td>${item.status}</td>
                </tr>`;
        });

        document.getElementById('consultation-result').style.display = 'block';
    }
</script>

</body>
</html>
