<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload de Planilha de Outages</title>
</head>
<body>
    <h1>Upload de Planilha de Outages</h1>

    <!-- Formulário para upload da planilha -->
    <input type="file" id="fileInput" accept=".csv">
    <button onclick="processFile()">Processar Planilha</button>

    <h2>Resultados</h2>
    
    <div id="result"></div>

    <h2>Consulta por Login</h2>
    <input type="text" id="loginInput" placeholder="Digite o Login">
    <button onclick="consultarPorLogin()">Consultar</button>

    <div id="consultaResult"></div>

    <script>
        let planilhaData = []; // Para armazenar os dados processados da planilha

        // Função para processar o arquivo CSV
        function processFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            if (!file) return alert("Por favor, faça o upload de uma planilha.");

            const reader = new FileReader();
            reader.onload = function(event) {
                const content = event.target.result;
                processCSV(content);
            };
            reader.readAsText(file);
        }

        // Função para processar o conteúdo do CSV
        function processCSV(content) {
            const lines = content.split('\n');
            planilhaData = lines.map(line => line.split(','));
            
            // Remover o cabeçalho
            planilhaData.shift();

            let resultado = '';
            let tempos = {};
            let perdasGanhos = {};
            let horariosPerda = {};
            let outagesPorLogin = {};

            // Iterar pelas linhas para calcular o tempo e identificar perdas/ganhos
            planilhaData.forEach((row) => {
                const [outage, login, inicio, fim, hfcVolume, hfcIndicador, gponVolume, gponIndicador] = row;

                // Ignorar casos onde HFC Volume ou GPON Volume começam com 0
                if (hfcVolume === '0' || gponVolume === '0') return;

                // Calcular o tempo (coluna E)
                const tempo = (new Date(fim) - new Date(inicio)) / 1000 / 60; // Tempo em minutos

                // Calcular HFC e GPON (Ganho ou Perda)
                const hfcStatus = hfcVolume === '1' && hfcIndicador === '1' ? 'Ganho' : 'Perda';
                const gponStatus = gponVolume === '1' && gponIndicador === '1' ? 'Ganho' : 'Perda';

                // Armazenar tempo médio por login
                if (!tempos[login]) tempos[login] = { totalTempo: 0, count: 0 };
                tempos[login].totalTempo += tempo;
                tempos[login].count++;

                // Armazenar perdas e ganhos
                if (!perdasGanhos[login]) perdasGanhos[login] = { ganho: 0, perda: 0 };
                if (hfcStatus === 'Ganho' || gponStatus === 'Ganho') perdasGanhos[login].ganho++;
                else perdasGanhos[login].perda++;

                // Armazenar horários de perda (para consulta por horário)
                const hora = new Date(inicio).getHours();
                if (!horariosPerda[hora]) horariosPerda[hora] = { perda: 0, ganho: 0 };
                if (hfcStatus === 'Perda' || gponStatus === 'Perda') horariosPerda[hora].perda++;
                else horariosPerda[hora].ganho++;

                // Armazenar outages por login
                if (!outagesPorLogin[login]) outagesPorLogin[login] = [];
                outagesPorLogin[login].push({ outage, hfcStatus, gponStatus });
            });

            // Exibir resultados
            resultado += "<h3>Tempos Médios por Login:</h3><ul>";
            for (const login in tempos) {
                const mediaTempo = tempos[login].totalTempo / tempos[login].count;
                resultado += `<li>${login}: ${mediaTempo.toFixed(2)} minutos</li>`;
            }

            resultado += "</ul><h3>Perdas/Ganhos por Login:</h3><ul>";
            for (const login in perdasGanhos) {
                resultado += `<li>${login}: Ganhos - ${perdasGanhos[login].ganho}, Perdas - ${perdasGanhos[login].perda}</li>`;
            }

            resultado += "</ul><h3>Horários com mais Perdas:</h3><ul>";
            for (const hora in horariosPerda) {
                resultado += `<li>Hora ${hora}: Perdas - ${horariosPerda[hora].perda}, Ganhos - ${horariosPerda[hora].ganho}</li>`;
            }

            document.getElementById("result").innerHTML = resultado;
        }

        // Função para consultar outages por login
        function consultarPorLogin() {
            const loginConsulta = document.getElementById("loginInput").value;
            const resultadoConsulta = outagesPorLogin[loginConsulta] || [];

            let resultado = '';
            if (resultadoConsulta.length === 0) {
                resultado = `<p>Nenhum outage encontrado para o login ${loginConsulta}.</p>`;
            } else {
                resultado = `<h3>Outages para o login ${loginConsulta}:</h3><ul>`;
                resultadoConsulta.forEach(({ outage, hfcStatus, gponStatus }) => {
                    resultado += `<li>Outage: ${outage}, HFC: ${hfcStatus}, GPON: ${gponStatus}</li>`;
                });
                resultado += "</ul>";
            }

            document.getElementById("consultaResult").innerHTML = resultado;
        }
    </script>
</body>
</html>
