<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel ETIT Móvel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* (Manter os estilos anteriores) */
    </style>
</head>
<body>
    <!-- (Manter a estrutura HTML anterior) -->

    <script>
        let dados = [];
        let performanceChart = null;
        const matriculaToNome = {
            "N6104793": "BRUNO MARIANO VILACA",
            "N5931955": "THIAGO DE SOUZA INACIO",
            "N6173067": "JULIANA RIBEIRO GALHÃO",
            "N6071740": "THIAGO BARBOZA DOS SANTOS",
            "N6172207": "CHARLES DOS SANTOS PAIVA",
            "F204763": "RODRIGO REIS DUARTE"
        };

        // Mapeamento reverso para busca por nome
        const nomeToMatricula = {};
        for (const [matricula, nome] of Object.entries(matriculaToNome)) {
            nomeToMatricula[nome.toUpperCase()] = matricula;
        }

        document.getElementById('upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            showSpinner();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (workbook.SheetNames.length === 0) {
                        throw new Error("O arquivo Excel não contém planilhas.");
                    }
                    
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
                    
                    if (rawData.length < 2 || rawData[0].length < 5) {
                        throw new Error("Formato de planilha inválido. Certifique-se de que contém pelo menos 5 colunas.");
                    }
                    
                    processDataInBatches(rawData, 1000);
                    
                } catch (error) {
                    hideSpinner();
                    alert(`Erro ao processar o arquivo: ${error.message}`);
                    console.error(error);
                    dados = [];
                    limparDados();
                }
            };
            
            reader.onerror = function() {
                hideSpinner();
                alert("Erro ao ler o arquivo. Por favor, tente novamente.");
                dados = [];
                limparDados();
            };
            
            reader.readAsArrayBuffer(file);
        });

        function processDataInBatches(rawData, batchSize) {
            // Resetar dados anteriores
            dados = [];
            const totalRows = rawData.length - 1;
            let processedRows = 0;
            
            function processBatch(start) {
                const end = Math.min(start + batchSize, rawData.length);
                
                for (let i = start; i < end; i++) {
                    if (i === 0) continue; // Pular cabeçalho
                    
                    const row = rawData[i];
                    if (row.length >= 5) {
                        // Processar cada linha individualmente
                        const incidente = row[0]?.toString().trim() || "N/A";
                        const nome = row[1]?.toString().trim().toUpperCase() || "N/A";
                        const dentroSLA = row[2]?.toString().trim().toLowerCase() === "sim";
                        const caixa = row[3]?.toString().trim() || "N/A";
                        const tipo = row[4]?.toString().trim() || "N/A";
                        
                        dados.push([incidente, nome, dentroSLA, caixa, tipo]);
                    }
                    processedRows++;
                    document.getElementById("progress").value = (processedRows / totalRows) * 100;
                }
                
                if (end < rawData.length) {
                    setTimeout(() => processBatch(end), 0);
                } else {
                    localStorage.setItem("dadosPlanilha", JSON.stringify(dados));
                    hideSpinner();
                    
                    // Exibir estatísticas reais após processamento
                    const totalIncidents = dados.length;
                    alert(`Planilha carregada com sucesso! ${totalIncidents} incidentes processados.`);
                    
                    updateTeamStats();
                }
            }
            
            processBatch(1);
        }

        function updateTeamStats() {
            const mediaEquipeDiv = document.getElementById("mediaEquipe");
            
            if (!dados || dados.length === 0) {
                mediaEquipeDiv.innerHTML = "";
                return;
            }
            
            // Calcular estatísticas reais
            const totalIncidents = dados.length;
            const dentroSLA = dados.filter(row => row[2]).length;
            const foraSLA = totalIncidents - dentroSLA;
            const percentualSLA = (dentroSLA / totalIncidents * 100).toFixed(2);
            
            // Calcular número de analistas únicos e média
            const analistas = new Set(dados.map(row => row[1]));
            const numAnalistas = analistas.size;
            const mediaPorAnalista = numAnalistas > 0 ? (totalIncidents / numAnalistas).toFixed(2) : 0;
            
            mediaEquipeDiv.innerHTML = `
                <div class="result-card">
                    <h3>Estatísticas Gerais da Equipe</h3>
                    <div class="stats-container">
                        <div class="stat-card">
                            <div>Total de Incidentes</div>
                            <div class="stat-value">${totalIncidents}</div>
                        </div>
                        <div class="stat-card">
                            <div>Dentro do SLA</div>
                            <div class="stat-value">${dentroSLA}</div>
                            <div>${percentualSLA}%</div>
                        </div>
                        <div class="stat-card">
                            <div>Fora do SLA</div>
                            <div class="stat-value">${foraSLA}</div>
                        </div>
                        <div class="stat-card">
                            <div>Analistas</div>
                            <div class="stat-value">${numAnalistas}</div>
                            <div>Média: ${mediaPorAnalista}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // (Manter as outras funções como showSpinner, hideSpinner, consultarETIT, etc.)
        
        function limparDados() {
            dados = [];
            localStorage.removeItem("dadosPlanilha");
            document.getElementById('matricula').value = "";
            document.getElementById('resultado').innerHTML = "";
            document.getElementById('mediaEquipe').innerHTML = "";
            document.getElementById('tabelaDentro').getElementsByTagName('tbody')[0].innerHTML = "";
            document.getElementById('tabelaFora').getElementsByTagName('tbody')[0].innerHTML = "";
            document.getElementById('upload').value = "";
            
            if (performanceChart) {
                performanceChart.destroy();
                performanceChart = null;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            // Não carregar dados automaticamente ao iniciar
            limparDados();
        });
    </script>
</body>
</html>
